generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Ingredienti (per gestione disponibilit√†)
model Ingredient {
  id            String                @id @default(cuid())
  name          String                @unique
  nameEn        String?               // English translation
  nameFr        String?               // French translation
  nameEs        String?               // Spanish translation
  nameHe        String?               // Hebrew translation
  inStock       Boolean               @default(true)
  menuType      String                @default("CLASSIC") // CLASSIC, SUSHI - per separare gli stock
  menuItems     MenuItemIngredient[]  // Ingrediente principale dei piatti
  modifiers     Modifier[]            // Usato come modificatore
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
}

// Relazione MenuItem <-> Ingrediente principale
model MenuItemIngredient {
  id           String     @id @default(cuid())
  menuItemId   String
  menuItem     MenuItem   @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)
  isPrimary    Boolean    @default(false) // Se true, piatto non disponibile quando ingrediente finisce

  @@unique([menuItemId, ingredientId])
}

// Sessione Festa (conto condiviso)
model PartySession {
  id          String   @id @default(cuid())
  code        String   @unique // Codice 6 caratteri per unirsi
  name        String?  // Nome festa opzionale
  hostTableId String?  // Tavolo che ha creato la festa
  isActive    Boolean  @default(true)
  orders      Order[]
  createdAt   DateTime @default(now())
  closedAt    DateTime?
}

// Tavoli del ristorante
model Table {
  id        String   @id @default(cuid())
  number    Int      @unique
  seats     Int      @default(4)
  qrCode    String   @unique
  status    String   @default("AVAILABLE") // AVAILABLE, OCCUPIED, RESERVED
  isCounter Boolean  @default(false) // true = banco (richiede customerName)
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Categorie del menu (Toast, Salad, etc.)
model Category {
  id          String     @id @default(cuid())
  name        String
  nameEn      String?    // English translation
  nameFr      String?    // French translation
  nameEs      String?    // Spanish translation
  nameHe      String?    // Hebrew translation
  description String?
  descriptionEn String?  // English translation
  descriptionFr String?  // French translation
  descriptionEs String?  // Spanish translation
  descriptionHe String?  // Hebrew translation
  imageUrl    String?
  sortOrder   Int        @default(0)
  active      Boolean    @default(true)
  items       MenuItem[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Piatti del menu
model MenuItem {
  id             String               @id @default(cuid())
  name           String
  nameEn         String?              // English translation
  nameFr         String?              // French translation
  nameEs         String?              // Spanish translation
  nameHe         String?              // Hebrew translation
  description    String?
  descriptionEn  String?              // English translation
  descriptionFr  String?              // French translation
  descriptionEs  String?              // Spanish translation
  descriptionHe  String?              // Hebrew translation
  price          Int                  // Prezzo in centesimi
  imageUrl       String?
  available      Boolean              @default(true)
  sortOrder      Int                  @default(0)
  categoryId     String
  category       Category             @relation(fields: [categoryId], references: [id])
  modifierGroups ModifierGroup[]
  orderItems     OrderItem[]
  ingredients    MenuItemIngredient[] // Ingredienti del piatto
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

// Gruppi di modificatori (es. "Extra ingredienti")
model ModifierGroup {
  id          String     @id @default(cuid())
  name        String
  nameEn      String?    // English translation
  nameFr      String?    // French translation
  nameEs      String?    // Spanish translation
  nameHe      String?    // Hebrew translation
  required    Boolean    @default(false)
  multiSelect Boolean    @default(false)
  minSelect   Int        @default(0)
  maxSelect   Int        @default(5)
  menuItemId  String
  menuItem    MenuItem   @relation(fields: [menuItemId], references: [id])
  modifiers   Modifier[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Singoli modificatori (es. "+ mozzarella", "+ avocado")
model Modifier {
  id              String              @id @default(cuid())
  name            String
  nameEn          String?             // English translation
  nameFr          String?             // French translation
  nameEs          String?             // Spanish translation
  nameHe          String?             // Hebrew translation
  price           Int                 @default(0) // Sovrapprezzo in centesimi
  available       Boolean             @default(true)
  modifierGroupId String
  modifierGroup   ModifierGroup       @relation(fields: [modifierGroupId], references: [id])
  ingredientId    String?             // Collegamento opzionale a ingrediente
  ingredient      Ingredient?         @relation(fields: [ingredientId], references: [id])
  orderItems      OrderItemModifier[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

// Ordini
model Order {
  id             String        @id @default(cuid())
  tableId        String
  table          Table         @relation(fields: [tableId], references: [id])
  items          OrderItem[]
  status         String        @default("PENDING") // PENDING, PREPARING, READY, SERVED, CANCELLED
  orderType      String        @default("DINE_IN") // DINE_IN, TAKEAWAY
  paymentMethod  String?       // CASH, CARD
  subtotal       Int           @default(0) // Subtotale in centesimi (senza sovrapprezzo)
  surcharge      Int           @default(0) // Sovrapprezzo carta (3%) in centesimi
  totalAmount    Int           // Totale finale in centesimi
  customerName   String?       // Nome cliente per take away o banco
  customerPhone  String?       // Telefono cliente per take away
  notes          String?
  partySessionId String?       // Sessione festa (conto condiviso)
  partySession   PartySession? @relation(fields: [partySessionId], references: [id])
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

// Elementi dell'ordine
model OrderItem {
  id          String              @id @default(cuid())
  orderId     String
  order       Order               @relation(fields: [orderId], references: [id])
  menuItemId  String
  menuItem    MenuItem            @relation(fields: [menuItemId], references: [id])
  quantity    Int                 @default(1)
  notes       String?
  consumeMode String              @default("DINE_IN") // DINE_IN, TAKEAWAY
  modifiers   OrderItemModifier[]
  createdAt   DateTime            @default(now())
}

// Modificatori applicati a un elemento dell'ordine
model OrderItemModifier {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])
  modifierId  String
  modifier    Modifier  @relation(fields: [modifierId], references: [id])
}
